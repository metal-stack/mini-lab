---
- name: Activate IP MASQUERADE on eth0
  ansible.builtin.iptables:
    chain: POSTROUTING
    jump: MASQUERADE
    out_interface: eth0
    table: nat

- name: Activate ipv4 forwarding on eth0
  ansible.posix.sysctl:
    name: net.ipv4.conf.eth0.forwarding
    reload: no
    sysctl_set: yes
    value: 1

- name: Set hostname
  ansible.builtin.command: config hostname {{ metal_partition_id }}-{{ inventory_hostname }}

- name: deploy configuration
  template:
    src: "{{ item }}.j2"
    dest: /etc/sonic/frr/{{ item }}
  loop:
    - bgpd.conf
    - staticd.conf
    - zebra.conf
  notify: bgp restart

- name: install services
  copy:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
  notify: reload systemd
  with_items:
    - bgp-validation@.service
    - write-to-db@.service

- name: deploy metal-core's configdb snippet
  template:
    src: metal-core.json.j2
    dest: /etc/sonic/metal-core.json
  notify: write metal-core.json into db

- ansible.builtin.include_tasks: lldp.yaml
